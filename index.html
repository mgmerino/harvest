<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Harvest - MVP</title>
    <style>
      :root {
        --bg: #0f0f12;
        --panel: #17171c;
        --ink: #e6e6f0;
        --muted: #a9acc0;
        --accent: #6ee7b7;
        --warn: #f59e0b;
        --danger: #ef4444;
        --grid: 4; /* NxN */
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          "Helvetica Neue",
          Arial;
        background: var(--bg);
        color: var(--ink);
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 16px;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 16px;
      }
      header {
        grid-column: 1/-1;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
      }
      .statbar {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .pill {
        background: var(--panel);
        border: 1px solid #262632;
        padding: 8px 10px;
        border-radius: 999px;
        font-weight: 600;
      }
      .pill small {
        display: block;
        font-weight: 500;
        color: var(--muted);
      }
      .btn {
        cursor: pointer;
        border: 1px solid #2b2b38;
        background: #1b1b23;
        color: var(--ink);
        padding: 8px 12px;
        border-radius: 12px;
        font-weight: 600;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn.primary {
        background: #1f2e26;
        border-color: #254335;
      }
      .btn.warn {
        background: #2a2316;
        border-color: #3d2e12;
      }
      .panel {
        background: var(--panel);
        border: 1px solid #252535;
        border-radius: 16px;
        padding: 12px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(var(--grid), minmax(0, 1fr));
        gap: 6px;
      }
      .tile {
        aspect-ratio: 1/1;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #2a2a39;
        border-radius: 12px;
        background: #14141a;
        position: relative;
      }
      .tile .emoji {
        font-size: 28px;
      }
      .tile .badge {
        position: absolute;
        top: 6px;
        right: 6px;
        font-size: 12px;
        background: #0009;
        padding: 2px 6px;
        border-radius: 10px;
      }
      .tile button {
        position: absolute;
        inset: 0;
        opacity: 0;
      }
      .tile:focus-within {
        outline: 2px solid #3a3a55;
      }
      .section-title {
        margin: 6px 0 8px;
        opacity: 0.9;
      }
      .list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
        padding: 8px;
        border: 1px dashed #2a2a38;
        border-radius: 10px;
      }
      .muted {
        color: var(--muted);
      }
      .shop {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      dialog {
        border: none;
        border-radius: 16px;
        padding: 0;
        background: transparent;
      }
      dialog .modal {
        background: var(--panel);
        border: 1px solid #2a2a3a;
        border-radius: 16px;
        width: min(720px, 92vw);
        padding: 16px;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .kbd {
        background: #111114;
        border: 1px solid #2c2c3c;
        padding: 0 6px;
        border-radius: 6px;
      }
      footer {
        grid-column: 1/-1;
        opacity: 0.65;
        font-size: 0.9rem;
        text-align: center;
        margin-top: 10px;
      }
      .hint {
        font-size: 0.9rem;
        color: var(--muted);
      }
      .danger {
        color: var(--danger);
      }
      .good {
        color: var(--accent);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="statbar">
          <div class="pill">
            üí∞ <span id="money">0</span><small>Dinero</small>
          </div>
          <div class="pill">
            üçì <span id="stock">0</span><small>Stock</small>
          </div>
          <div class="pill">
            üìà <span id="price">1.00</span><small>‚Ç¨/fruto</small>
          </div>
          <div class="pill">
            üîí <span id="reserve">0</span><small>Reserva 10%</small>
          </div>
          <div class="pill">
            ‚öôÔ∏è <span id="tick">0</span><small>Ticks</small>
          </div>
        </div>
        <div class="statbar">
          <button class="btn" id="btnHarvest">Cosechar todo</button>
          <button class="btn" id="btnSell">Vender excedente</button>
          <button class="btn primary" id="btnShop">
            Mejoras / Automatizaciones
          </button>
          <button class="btn" id="btnSave">Guardar</button>
          <button class="btn" id="btnReset">Reset</button>
        </div>
      </header>

      <aside class="panel">
        <h3 class="section-title">Parcela (<span id="sizeLabel"></span>)</h3>
        <div class="grid" id="grid"></div>
        <p class="hint">
          Consejo: haz clic en una planta para ver su estado y acciones (regar,
          replantar, etc.).
        </p>
        <div id="selected" class="panel" style="margin-top: 10px">
          <h3>Planta seleccionada</h3>
          <div id="plantInfo" class="muted">Ninguna.</div>
          <div
            id="actions"
            style="display: flex; gap: 8px; margin-top: 8px"
          ></div>
        </div>
      </aside>

      <main class="panel">
        <h3 class="section-title">Registro</h3>
        <div id="log" class="list"></div>
      </main>

      <footer>
        Harvest ‚Äî MVP. Guardado autom√°tico cada 30s. Emojis como "gr√°ficos". üíæ
      </footer>
    </div>

    <!-- Modal tienda -->
    <dialog id="shopDialog">
      <div class="modal">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
          "
        >
          <h3>Mejoras & Automatizaciones</h3>
          <button class="btn" onclick="shopDialog.close()">Cerrar</button>
        </div>
        <div class="grid-2">
          <section class="panel">
            <h4>Mejoras</h4>
            <div class="shop" id="shopUpgrades"></div>
          </section>
          <section class="panel">
            <h4>Automatizaciones</h4>
            <div class="shop" id="shopAutos"></div>
          </section>
        </div>
      </div>
    </dialog>

    <script>
      /*** GAME STATE ***/
      const TICK_MS = 500; // ritmo de simulaci√≥n
      const GRID_N = 4; // 4x4 (editable)

      const defaultState = () => ({
        money: 0,
        stock: 0,
        tick: 0,
        priceBase: 1,
        qualityLevel: 0, // multiplica el precio
        growthLevel: 0, // multiplica la velocidad de crecimiento
        yieldLevel: 0, // multiplica la cosecha por planta
        autos: { sprinkler: false, picker: false, vendor: false },
        field: Array(GRID_N * GRID_N)
          .fill(null)
          .map((_, i) => newPlant(i === 0)), // empieza con 1 planta
      });

      function newPlant(start = false) {
        return {
          alive: start, // si hay planta en la parcela
          stage: start ? "seedling" : "empty", // empty | seedling | growing | ripe
          water: start ? 50 : 0, // 0-100
          growth: start ? 0 : 0, // 0-100
          quality: 1, // factor individual (afectado por upgrades globales)
          fruits: 0, // frutos listos en la planta (cuando ripe)
        };
      }

      let S = load() || defaultState();

      /*** ECONOM√çA Y REGLAS ***/
      function pricePerFruit() {
        const qualityMult = 1 + S.qualityLevel * 0.25; // +25% por nivel
        return +(S.priceBase * qualityMult).toFixed(2);
      }

      function growthRate() {
        const base = 2; // puntos por tick
        return base * (1 + S.growthLevel * 0.25);
      }

      function yieldPerCycle() {
        const base = 2; // frutos por ciclo
        return Math.round(base * (1 + S.yieldLevel * 0.4));
      }

      function reserveAmount() {
        return Math.ceil(S.stock * 0.1); // 10% bloqueado
      }

      /*** UI ***/
      const elGrid = document.getElementById("grid");
      const elLog = document.getElementById("log");
      const elMoney = document.getElementById("money");
      const elStock = document.getElementById("stock");
      const elPrice = document.getElementById("price");
      const elReserve = document.getElementById("reserve");
      const elTick = document.getElementById("tick");
      const elSizeLabel = document.getElementById("sizeLabel");
      const plantInfo = document.getElementById("plantInfo");
      const actions = document.getElementById("actions");
      const shopDialog = document.getElementById("shopDialog");
      const shopUpgrades = document.getElementById("shopUpgrades");
      const shopAutos = document.getElementById("shopAutos");

      document.documentElement.style.setProperty("--grid", GRID_N);
      elSizeLabel.textContent = GRID_N + "x" + GRID_N;

      function tileEmoji(p) {
        if (!p || !p.alive) return "‚¨õÔ∏è";
        if (p.stage === "seedling") return "üå±";
        if (p.stage === "growing") return "ü™¥";
        if (p.stage === "ripe") return "üçì";
        return "‚¨úÔ∏è";
      }

      function render() {
        // header
        elMoney.textContent = S.money.toFixed(2);
        elStock.textContent = S.stock;
        elPrice.textContent = pricePerFruit().toFixed(2);
        elReserve.textContent = reserveAmount();
        elTick.textContent = S.tick;

        // grid
        elGrid.innerHTML = "";
        S.field.forEach((p, idx) => {
          const tile = document.createElement("div");
          tile.className = "tile";
          const em = document.createElement("div");
          em.className = "emoji";
          em.textContent = tileEmoji(p);
          tile.appendChild(em);
          const badge = document.createElement("div");
          badge.className = "badge";
          badge.textContent =
            p && p.alive
              ? `${Math.floor(p.growth)}% | üíß${Math.floor(p.water)}`
              : "vac√≠o";
          tile.appendChild(badge);
          const btn = document.createElement("button");
          btn.title = "Seleccionar";
          btn.addEventListener("click", () => selectPlant(idx));
          tile.appendChild(btn);
          elGrid.appendChild(tile);
        });

        // tienda
        renderShop();
      }

      let selectedIndex = -1;
      function selectPlant(i) {
        selectedIndex = i;
        const p = S.field[i];
        actions.innerHTML = "";
        if (!p || !p.alive) {
          plantInfo.innerHTML = `<b>Parcela ${i + 1}</b>: <span class="muted">vac√≠a</span>`;
          addAction("üå± Replantar (1 fruto)", () => {
            if (S.stock <= reserveAmount())
              return toast("No puedes usar la reserva.");
            if (S.stock <= 0) return toast("Sin frutos en stock.");
            S.stock -= 1;
            S.field[i] = newPlant(true);
            log("Has replantado una parcela con 1 fruto.");
            render();
          });
          return;
        }
        const stageLabel =
          p.stage === "seedling"
            ? "brote"
            : p.stage === "growing"
              ? "creciendo"
              : "madura";
        plantInfo.innerHTML = `<b>Planta ${i + 1}</b> ‚Äî estado: <b>${stageLabel}</b><br>
      Crecimiento: ${Math.floor(p.growth)}% ¬∑ Agua: ${Math.floor(p.water)}/100 ¬∑ Calidad: x${(p.quality * (1 + S.qualityLevel * 0.25)).toFixed(2)} ${p.stage === "ripe" ? `¬∑ Frutos: ${p.fruits}` : ""}`;

        addAction("üíß Regar (+20)", () => {
          p.water = Math.min(100, p.water + 20);
          log(`Has regado la planta ${i + 1}.`);
          render();
        });
        addAction("üßØ Purgar agua (-20)", () => {
          // por si te pasas
          p.water = Math.max(0, p.water - 20);
          render();
        });
        if (p.stage === "ripe" && p.fruits > 0) {
          addAction("üß∫ Cosechar", () => {
            S.stock += p.fruits;
            log(`Cosecha manual de planta ${i + 1}: +${p.fruits} üçì.`);
            p.fruits = 0;
            p.stage = "growing";
            p.growth = 0; // nuevo ciclo
            render();
          });
        }
        addAction("ü™ì Quitar planta", () => {
          S.field[i] = newPlant(false);
          log(`Has quitado la planta ${i + 1}.`);
          render();
        });
      }

      function addAction(label, fn) {
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = label;
        b.onclick = fn;
        actions.appendChild(b);
      }

      /*** LOOP ***/
      function step() {
        S.tick++;
        S.field.forEach((p) => {
          if (!p.alive) return;
          // consumo de agua
          p.water = Math.max(0, p.water - 0.8);
          // si no hay agua, se detiene el crecimiento (o retrocede levemente)
          const hydrated = p.water >= 20;
          if (hydrated) {
            p.growth = Math.min(100, p.growth + growthRate());
          } else {
            p.growth = Math.max(0, p.growth - 0.5);
          }
          // transici√≥n de estados
          if (p.growth >= 100 && p.stage !== "ripe") {
            p.stage = "ripe";
            p.fruits = yieldPerCycle();
          } else if (p.stage === "seedling" && p.growth >= 25) {
            p.stage = "growing";
          }
        });

        // Automatizaciones
        if (S.autos.sprinkler) {
          S.field.forEach((p) => {
            if (p.alive && p.water < 60) p.water = Math.min(100, p.water + 6);
          });
        }
        if (S.autos.picker) {
          S.field.forEach((p) => {
            if (p.alive && p.stage === "ripe" && p.fruits > 0) {
              S.stock += p.fruits;
              p.fruits = 0;
              p.stage = "growing";
              p.growth = 0;
            }
          });
        }
        if (S.autos.vendor) {
          autoSellExcess();
        }

        if (S.tick % 10 === 0) render();
      }

      /*** VENDER ***/
      function sell(amount) {
        const minKeep = reserveAmount();
        const sellable = Math.max(0, S.stock - minKeep);
        const n = Math.min(amount, sellable);
        if (n <= 0) {
          toast("Nada que vender (respeta la reserva del 10%).");
          return 0;
        }
        const total = n * pricePerFruit();
        S.stock -= n;
        S.money += total;
        log(`Vendidos ${n} üçì por ${total.toFixed(2)} ‚Ç¨.`);
        return n;
      }

      function autoSellExcess() {
        const minKeep = reserveAmount();
        const sellable = S.stock - minKeep;
        if (sellable > 0) sell(sellable);
      }

      /*** MEJORAS & AUTOS ***/
      const UPGRADES = [
        {
          key: "quality",
          label: "Fertilizante premium (+25% precio)",
          price: 30,
          apply: () => S.qualityLevel++,
        },
        {
          key: "growth",
          label: "Riego por goteo (+25% crecimiento)",
          price: 40,
          apply: () => S.growthLevel++,
        },
        {
          key: "yield",
          label: "Sustrato rico (+40% frutos/ciclo)",
          price: 60,
          apply: () => S.yieldLevel++,
        },
        {
          key: "plot",
          label: "Ampliar parcela (+1 planta)",
          price: 50,
          apply: () => addOnePlantSlot(),
        },
      ];

      const AUTOS = [
        { key: "sprinkler", label: "Aspersor autom√°tico (riega)", price: 80 },
        { key: "picker", label: "Recolector autom√°tico", price: 120 },
        { key: "vendor", label: "Vendedor autom√°tico", price: 150 },
      ];

      function renderShop() {
        // Upgrades
        shopUpgrades.innerHTML = "";
        UPGRADES.forEach((u) => {
          const row = document.createElement("div");
          row.className = "row";
          const owned =
            u.key === "quality"
              ? S.qualityLevel
              : u.key === "growth"
                ? S.growthLevel
                : u.key === "yield"
                  ? S.yieldLevel
                  : 0;
          row.innerHTML = `<div>${u.label} ${owned ? `<span class="kbd">Nivel ${owned}</span>` : ""}</div>`;
          const b = document.createElement("button");
          b.className = "btn primary";
          b.textContent = `Comprar ‚Äî ${u.price}‚Ç¨`;
          b.disabled = S.money < u.price;
          b.onclick = () => {
            if (S.money >= u.price) {
              S.money -= u.price;
              u.apply();
              log(`Comprado: ${u.label}.`);
              render();
            }
          };
          row.appendChild(b);
          shopUpgrades.appendChild(row);
        });

        // Autos
        shopAutos.innerHTML = "";
        AUTOS.forEach((a) => {
          const row = document.createElement("div");
          row.className = "row";
          const active = !!S.autos[a.key];
          row.innerHTML = `<div>${a.label} ${active ? '<span class="kbd good">Activo</span>' : ""}</div>`;
          const b = document.createElement("button");
          b.className = "btn warn";
          b.textContent = active ? "Comprado" : `Comprar ‚Äî ${a.price}‚Ç¨`;
          b.disabled = active || S.money < a.price;
          b.onclick = () => {
            if (!active && S.money >= a.price) {
              S.money -= a.price;
              S.autos[a.key] = true;
              log(`Automatizaci√≥n activada: ${a.label}.`);
              render();
            }
          };
          row.appendChild(b);
          shopAutos.appendChild(row);
        });
      }

      function addOnePlantSlot() {
        const idx = S.field.findIndex((p) => !p || !p.alive);
        if (idx !== -1) {
          S.field[idx] = newPlant(true);
          return;
        }
        // si no hay espacios vac√≠os, a√±ade una nueva casilla si cabe en la cuadr√≠cula actual
        // (para MVP, simplemente planta en la primera vac√≠a; si todas ocupadas, reemplaza la √∫ltima)
        S.field.push(newPlant(true));
        // NOTA: para mantener la cuadr√≠cula visual, podr√≠as aumentar GRID_N din√°micamente (fuera del MVP)
      }

      /*** LOG, TOAST, SAVE ***/
      function log(text) {
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `<div>${text}</div>`;
        elLog.prepend(row);
      }
      function toast(text) {
        log(`<span class="danger">${text}</span>`);
      }

      function save() {
        localStorage.setItem("harvest_mvp", JSON.stringify(S));
      }
      function load() {
        try {
          return JSON.parse(localStorage.getItem("harvest_mvp"));
        } catch {
          return null;
        }
      }

      /*** CONTROLES ***/
      document.getElementById("btnHarvest").onclick = () => {
        let total = 0;
        S.field.forEach((p) => {
          if (p && p.alive && p.stage === "ripe" && p.fruits > 0) {
            total += p.fruits;
            p.fruits = 0;
            p.stage = "growing";
            p.growth = 0;
          }
        });
        if (total > 0) {
          S.stock += total;
          log(`Cosecha global: +${total} üçì.`);
          render();
        } else toast("No hay frutos maduros.");
      };
      document.getElementById("btnSell").onclick = () => {
        const sold = sell(1e9);
        if (sold > 0) render();
      };
      document.getElementById("btnShop").onclick = () => shopDialog.showModal();
      document.getElementById("btnSave").onclick = () => {
        save();
        log("Partida guardada.");
      };
      document.getElementById("btnReset").onclick = () => {
        if (confirm("¬øResetear partida?")) {
          localStorage.removeItem("harvest_mvp");
          S = defaultState();
          render();
          log("Partida reiniciada.");
        }
      };

      // Auto-save cada 30s
      setInterval(() => save(), 30000);
      // Game loop
      setInterval(step, TICK_MS);

      // Bootstrap
      render();
      log("¬°Bienvenido! Riega la planta inicial y empieza a cosechar.");
    </script>
  </body>
</html>
